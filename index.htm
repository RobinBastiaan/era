<!doctype html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Era</title>
    <style>
        :root {
            --hulpstaff-color: #FEE9A0;
            --staff-color: #fccf2d;
            --hopman-color: #ffb700;
        }

        #source-table { /* only show the source table when editing the page */
            //display: none;
        }
        #era {
            border: 1px solid black;
            background: repeating-linear-gradient(to right, white, white 100px, #F4F4F4 100px, #F4F4F4 200px);
         }
        .legend {
            position: relative;
            display: inline-block;
            width: 94px;
            background-color: lightgrey;
            font-weight: 700;
            text-align: center;
            border: 3px solid black;
        }
        .staff-member {
            position: relative;
            height: 18px;
            padding: 10px 10px 10px 40px;
            margin: 5px;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            clear: both;
            transition: .2s;
        }
        .staff-member:hover {
            height: 22px;
            font-weight: bolder;
            font-size: 19px;
            padding: 8px 10px 8px 40px;
            filter: brightness(97%);
        }
        .staff-member--no-end {
            border-radius: 18px 0 0 18px;
        }
        .staff-member--no-end:after {
            content: "";
            height: 110%;
            margin-top: -10px;
            position: absolute;
            z-index: 1;
            width: 50px;
            right: 0;
            opacity: 1;
            background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
        }
        .staff-member__image {
            position: absolute;
            width: 36px;
            margin: -9px -39px;
            border-radius: 100%;
            transition: .2s;
        }
        .staff-member:hover .staff-member__image {
            width: 38px;
            margin: -8px -40px;
        }
        .staff-member__tooltip {
            display: none;
            position: relative;
            width: 120px;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            margin-left: 5px;
        }
        .staff-member:hover .staff-member__tooltip {
            display: inline;
        }
    </style>
</head>
<body>

    <!-- The source table -->
    <table id="source-table" style="width: 600px;">
        <tbody>
        <tr>
            <td><strong>Staflid</strong></td>
            <td><strong>Hulpvaandrig sinds</strong></td>
            <td><strong>Vaandrig sinds</strong></td>
            <td><strong>Hopman sinds</strong></td>
            <td><strong>Eindjaar</strong></td>
        </tr>
        <tr>
            <td>Robin</td>
            <td>2010</td>
            <td>2011</td>
            <td></td>
            <td>2020</td>
        </tr>
        <tr>
            <td>Wilco</td>
            <td>2010</td>
            <td>2011</td>
            <td>2015</td>
            <td>2020</td>
        </tr>
        <tr>
            <td>Leon</td>
            <td></td>
            <td>2013</td>
            <td>2020</td>
            <td></td>
        </tr>
        <tr>
            <td>Rik</td>
            <td></td>
            <td>2015</td>
            <td></td>
            <td>2019</td>
        </tr>
        <tr>
            <td>Martijn</td>
            <td>2018</td>
            <td>2019</td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>Rowan</td>
            <td></td>
            <td>2010</td>
            <td></td>
            <td>2016</td>
        </tr>
        </tbody>
    </table>

    <hr>

    <!-- The Era div -->
    <div id="era"></div>

    <!-- Since the platform does not allow larger script tags, it is split -->
    <script>
        // get the smallest starting year
        function getMinYear() {
            let minYear = Number.MAX_SAFE_INTEGER; // init
            let children = document.getElementById("source-table").children[0];
            let len = children.childElementCount;
            for (let i = 1; i < len; i++) {
                let year = parseInt(children.children[i].children[1].innerHTML); // parseInt to remove e.g. &nbsp;
                if (year < minYear) {
                    minYear = year;
                }
                year = parseInt(children.children[i].children[2].innerHTML); // parseInt to remove e.g. &nbsp;
                if (year < minYear) {
                    minYear = year;
                }
            }
            return minYear;
        }

        // get the biggest ending year
        function getMaxYear() {
            let maxYear = 0; // init
            let children = document.getElementById("source-table").children[0];
            let len = children.childElementCount;
            for (let i = 1; i < len; i++) {
                let year = parseInt(children.children[i].children[4].innerHTML); // parseInt to remove e.g. &nbsp;
                if (year > maxYear) {
                    maxYear = year;
                }
            }
            return maxYear;
        }

        // to allow sorting on the starting column
        function compareColumn(a, b) {
            if (a[2] === b[2]) {
                return 0;
            }
            else {
                return (a[2] < b[2]) ? -1 : 1;
            }
        }
    </script>
    <script>
        // show the entire timeline of the era
        function showEra() {
            let minYear = getMinYear();
            let maxYear = getMaxYear();

            document.getElementById("era").style.width = (maxYear - minYear + 1)*100 + "px";

            // show legend
            for (let i = minYear; i <= maxYear; i++) {
                let div = document.createElement("div");
                div.classList.add("legend");
                div.append(`${i}`);
                document.getElementById("era").append(div);
            }

            // show all members
            let children = document.getElementById("source-table").children[0];
            let len = children.childElementCount;
            let staffArray = [];
            for (let i = 1; i < len; i++) {
                var valueToPush = [];
                for (let j = 0; j <= 4; j++) {
                    valueToPush[j] = children.children[i].children[j].innerHTML;
                }
                staffArray.push(valueToPush);
            }
            staffArray.sort(compareColumn);

            // and it is sorted, loop each staff member to display on page
            for (let i = 0; i < len-1; i++) {
                console.log(staffArray[i]);
                let name = staffArray[i][0];
                let beginHulpStaff = staffArray[i][1];
                let beginStaff = staffArray[i][2];
                let beginHopman = staffArray[i][3];
                let rawEnd = staffArray[i][4];
                let begin = Math.min(beginHulpStaff === "" ? Infinity : beginHulpStaff,
                    beginStaff === "" ? Infinity : beginStaff, beginHopman === "" ? Infinity : beginHopman);
                let ended = rawEnd !== "";
                let noEndWidth = rawEnd === "" ? 50 : 0;
                let stillStaffWidth = !rawEnd && beginHopman === "" ? 50 : 0;
                let end = rawEnd === "" ? new Date().getFullYear() : rawEnd; // if not ended; take current year
                let durationHulpStaff = beginHulpStaff === "" ? 0 : beginStaff - beginHulpStaff;
                let durationStaff = beginStaff === "" ? 0 : (beginHopman === "" ? end - beginStaff : beginHopman - beginStaff);
                let durationHopman = beginHopman === "" ? 0 : end - beginHopman;

                let div = document.createElement("div");
                div.classList.add("staff-member");
                if (!ended) div.classList.add("staff-member--no-end");
                div.style.cssText = `margin-left: ${(begin-minYear)*100+50}px;` +
                                    `width: ${(end-begin)*100-50+noEndWidth}px;` +
                                    `background: linear-gradient(to right, var(--hulpstaff-color), var(--hulpstaff-color) ${(durationHulpStaff)*100}px,\n` +
                                    `var(--staff-color) ${(durationHulpStaff)*100}px, var(--staff-color) ${(durationHulpStaff + durationStaff)*100+stillStaffWidth}px,\n` +
                                    `var(--hopman-color) ${(durationHulpStaff + durationStaff)*100+stillStaffWidth}px, var(--hopman-color) ${(durationHulpStaff + durationStaff + durationHopman)*100}px);`;

                // add image
                let img = document.createElement("img");
                img.classList.add("staff-member__image");
                img.src = `src/${name}.jpg`;
                img.alt = `${name}`;
                div.append(img);

                let span = document.createElement("span");
                if (ended) {
                    span.append(`${name} (${begin} - ${end})`);
                } else { // only show begin year when no yet ended
                    span.append(`${name} (${begin})`);
                }
                div.append(span);

                // create the tooltip, but only if the duration is more than 5 years
                if (durationHulpStaff + durationStaff + durationHopman > 5) {
                    let tooltip = document.createElement("span");
                    tooltip.classList.add("staff-member__tooltip");
                    let titleText = '';
                    if (durationHulpStaff > 0) titleText = titleText.concat(`${durationHulpStaff} jaar hulpstaf`);
                    if (durationHulpStaff > 0 && durationStaff > 0) titleText = titleText.concat(`, `);
                    if (durationStaff > 0) {
                        if (!rawEnd && isNaN(beginHopman)) { // still staff
                            titleText = titleText.concat(`al ${durationStaff} jaar staflid`);
                        } else {
                            titleText = titleText.concat(`${durationStaff} jaar staflid`);
                        }
                    }
                    if (durationStaff > 0 && !isNaN(beginHopman)) titleText = titleText.concat(`, `);
                    if (!isNaN(beginHopman)) {
                        if (!rawEnd) { // still hopman
                            titleText = titleText.concat(`al ${durationHopman} jaar hopman`);
                        } else {
                            titleText = titleText.concat(`${durationHopman} jaar hopman`);
                        }
                    }
                    tooltip.append(titleText);
                    div.append(tooltip);
                }
                document.getElementById("era").append(div);
            }
        }

        showEra();
    </script>
</body>
</html>